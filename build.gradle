import javax.security.auth.login.ConfigurationSpi;
import com.sun.org.apache.bcel.internal.util.ClassPath;

apply plugin: 'eclipse'
apply plugin: 'war'
apply plugin: 'sonar'
apply plugin: 'java'

webAppDirName = 'WebContent'

sourceCompatibility=1.7
targetCompatibility=1.7

ext.springVersion = '3.2.1.RELEASE'
ext.springSecurityVersion = '3.1.3.RELEASE'
ext.springDataVersion = '1.2.0.RELEASE'
ext.springWebFlowVersion = '2.3.1.RELEASE'
ext.springSocialVersion = '1.0.2.RELEASE' 
ext.querydslVersion = '2.9.0'
ext.hibernateVersion = '4.1.9.Final'
ext.hibernateValidatorVersion = '4.3.0.Final'
ext.droolsVersion = '5.4.0.Final'
ext.junitVersion = '4.11'
ext.jodaTimeVersion = '2.1'
ext.apacheCommonsCodecVersion = '1.7'
ext.log4jVersion = '1.2.17'
ext.dbmaintainVersion = '2.4'
ext.aspectjVersion = '1.7.1'
ext.tilesVersion = '3.0.1'

sourceSets.main.java.srcDir 'src/querydsl/java'

configureEnv()

repositories{
	maven{
		url "${repositoryHost}/artifactory/repo"
	}
}

dependencies{
	compile ("org.springframework.security:spring-security-web:${springSecurityVersion}")
	runtime ("org.springframework.security:spring-security-taglibs:${springSecurityVersion}")
	runtime ("org.springframework.security:spring-security-config:${springSecurityVersion}")
	compile ("org.springframework:spring-context:${springVersion}")
	compile ("org.springframework:spring-test:${springVersion}")
	runtime ("org.springframework:spring-webmvc:${springVersion}")
	compile ("org.springframework.data:spring-data-jpa:${springDataVersion}")
	compile ("org.springframework.social:spring-social-web:${springSocialVersion}")
	compile ("org.springframework.social:spring-social-facebook:${springSocialVersion}")
	compile ("org.springframework.social:spring-social-facebook-web:${springSocialVersion}")
	compile ("org.springframework.social:spring-social-twitter:${springSocialVersion}")
	compile ("org.springframework.webflow:spring-webflow:${springWebFlowVersion}")

	compile ("commons-codec:commons-codec:${apacheCommonsCodecVersion}")
	compile ("commons-lang:commons-lang:2.6")
	compile ("commons-collections:commons-collections:3.2.1")
	compile ("commons-beanutils:commons-beanutils:1.8.0")
	runtime ("commons-dbcp:commons-dbcp:1.4")

	compile ("org.hibernate:hibernate-entitymanager:${hibernateVersion}")
	compile ("org.hibernate:hibernate-validator-annotation-processor:${hibernateValidatorVersion}")
	compile ("org.hibernate:hibernate-validator:${hibernateValidatorVersion}")

	providedCompile ("javax.servlet:servlet-api:2.5")
	providedCompile ("javax.servlet.jsp:jsp-api:2.1")
	compile ("javax.servlet:jstl:1.2")

	compile ("com.mysema.querydsl:querydsl-jpa:${querydslVersion}")
	compile ("com.mysema.querydsl:querydsl-apt:${querydslVersion}")

	compile ("org.drools:drools-core:${droolsVersion}")
	compile ("org.drools:drools-compiler:${droolsVersion}")

	runtime ("org.apache.tiles:tiles-core:${tilesVersion}")
	runtime ("org.apache.tiles:tiles-jsp:${tilesVersion}")
	
	compile ("junit:junit:${junitVersion}")
	compile ("joda-time:joda-time:${jodaTimeVersion}")
	compile ("log4j:log4j:${log4jVersion}")
	compile ("org.javassist:javassist:3.15.0-GA")
	compile ("javax.validation:validation-api:1.0.0.GA")
	compile ("org.dbmaintain:dbmaintain:${dbmaintainVersion}")
	runtime ("mysql:mysql-connector-java:5.1.22")
	runtime ("org.aspectj:aspectjweaver:${aspectjVersion}")
	compile ("org.mockito:mockito-all:1.9.5")
	
}

sonar{
	server{
		url = "${sonarHost}/sonar"
	}
	database{
		url = "jdbc:mysql://192.168.10.9:3306/sonar?useUnicode=true&characterEncoding=utf8&rewriteBatchedStatements=true"
		driverClassName = "com.mysql.jdbc.Driver"
		username = "sonar"
		password = "sonar"
	}
	project{
		key="openserv:openserv"
	}
}

def configureEnv(){
	ext.environment = hasProperty('teamcity')?'ci':hasProperty('environment')?environment:'local'
	ext.repositoryHost = hasProperty('teamcity')?'http://192.168.10.9:8081':'https://www.laertessoft.biz'
//	ext.repositoryHost = 'http://192.168.10.9:8081'
	ext.sonarHost = hasProperty('teamcity')?'http://192.168.10.9:9000':'https://www.laertessoft.biz'
	println "Building environment: $environment"
	def config = new ConfigSlurper().parse(file('env/'+environment+'.gradle').toURI().toURL())
	ext.config = config	
}

task generateQueryDSL (type: JavaCompile) {
		source = 'src/main/java'
		classpath = configurations.compile
		options.compilerArgs = [
			"-proc:only",
			"-processor", "com.mysema.query.apt.hibernate.HibernateAnnotationProcessor"
		]
		destinationDir = file('src/querydsl/java')
}

task updateDatabase{
	ant.taskdef(resource: "dbmaintain-anttasks.xml", classpath: configurations.runtime.asPath)
	ant.projectDir = projectDir
	ant.updateDatabase(scriptLocations: '${projectDir}/src/main/dbscripts', autoCreateDbMaintainScriptsTable: true, qualifiers: 'scripts', fromScratchEnabled: true){
		database(driverClassName: config.openserv.db.driver, 
				url: config.openserv.db.url, 
				userName: config.openserv.db.username, 
				password: config.openserv.db.password,
				schemaNames: config.openserv.db.schemas)	
	}
}

task packageScripts{
	ant.taskdef(resource: "dbmaintain-anttasks.xml", classpath: configurations.runtime.asPath)
	ant.projectDir = projectDir
	ant.createScriptArchive(scriptLocations: '${projectDir}/src/main/dbscripts', 
							qualifiers: 'scripts', 
							archiveFileName: "openserv-scripts.zip")
}

compileJava.dependsOn generateQueryDSL
test.dependsOn updateDatabase
assemble.dependsOn packageScripts

task wrapper(type: Wrapper){
	gradleVersion = '1.3'
}

// Find any 3rd party libraries which have released new versions
// to the central Maven repo since we last upgraded.
task checkLibVersions << {
  def checked = [:]
  def detachedConfig = configurations.detachedConfiguration()
  allprojects{
	  configurations.each{configuration ->
		  configuration.allDependencies.each{ dependency ->
			  detachedConfig.dependencies.add(dependencies.create(dependency.group+':'+dependency.name+':latest.integration'))
		  }
	  }
  }	
  
  def allVersions = detachedConfig.incoming.resolutionResult.allModuleVersions
  allVersions.removeAll{it.id.version.toLowerCase().contains('alpha')}
  allVersions.removeAll{it.id.version.toLowerCase().contains('beta')}
  allVersions.removeAll{it.id.version.toLowerCase().contains('rc')}

  allprojects{
	  configurations.each{configuration ->
		  configuration.allDependencies.each{ dependency ->
			  def newest = allVersions.findResult{(it.id.group == dependency.group && it.id.name == dependency.name)?it:null}
			  if(newest != null && dependency.version != newest.id.version) {
				  println "$dependency.group:$dependency.name $dependency.version -> $newest.id.version"
			  }

		  }
	  }
  }	
}

